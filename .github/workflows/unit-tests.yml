name: Unit Tests

on:
  workflow_call:  # Can be called by other workflows
  pull_request:
    branches:
      - main
      - master
      - develop
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  push:
    branches:
      - main
      - master
      - develop

permissions:
  contents: read
  checks: write
  pull-requests: write

# Cancel in-progress runs of the same workflow for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Run unit tests
      run: mvn test -P unit-tests
      continue-on-error: false
      
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: target/surefire-reports/
        retention-days: 7
    
    - name: Upload HTML Test Report on Failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: unit-test-html-report
        path: target/surefire-reports/
        retention-days: 7

    - name: Generate test report
      if: always() && github.event_name == 'push'
      uses: dorny/test-reporter@v1
      with:
        name: Unit Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: true
      continue-on-error: true

    - name: Publish test results summary
      if: always()
      run: |
        echo "# üß™ Unit Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -d target/surefire-reports ]; then
          # Parse test results from XML files
          TOTAL_TESTS=0
          FAILURES=0
          ERRORS=0
          SKIPPED=0
          PASSED=0

          echo "<details open>" >> $GITHUB_STEP_SUMMARY
          echo "<summary><b>üìä Unit Test Summary</b></summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List all test files found
          echo "**Test Suites:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in target/surefire-reports/TEST-*.xml; do
            if [ -f "$file" ]; then
              CLASSNAME=$(basename "$file" .xml | sed 's/TEST-//')
              TESTS=$(grep -oP 'tests="\K[0-9]+' "$file" 2>/dev/null || grep 'tests=' "$file" | sed 's/.*tests="\([0-9]*\)".*/\1/' | head -1)
              FAILS=$(grep -oP 'failures="\K[0-9]+' "$file" 2>/dev/null || grep 'failures=' "$file" | sed 's/.*failures="\([0-9]*\)".*/\1/' | head -1)
              ERRS=$(grep -oP 'errors="\K[0-9]+' "$file" 2>/dev/null || grep 'errors=' "$file" | sed 's/.*errors="\([0-9]*\)".*/\1/' | head -1)
              SKIP=$(grep -oP 'skipped="\K[0-9]+' "$file" 2>/dev/null || grep 'skipped=' "$file" | sed 's/.*skipped="\([0-9]*\)".*/\1/' | head -1)

              TOTAL_TESTS=$((TOTAL_TESTS + ${TESTS:-0}))
              FAILURES=$((FAILURES + ${FAILS:-0}))
              ERRORS=$((ERRORS + ${ERRS:-0}))
              SKIPPED=$((SKIPPED + ${SKIP:-0}))

              # Show status for each test class (only non-integration tests)
              if [[ ! "$CLASSNAME" =~ IntegrationTest$ ]]; then
                if [ ${FAILS:-0} -eq 0 ] && [ ${ERRS:-0} -eq 0 ]; then
                  echo "- ‚úÖ \`$CLASSNAME\` ($TESTS tests)" >> $GITHUB_STEP_SUMMARY
                else
                  echo "- ‚ùå \`$CLASSNAME\` ($TESTS tests, $((FAILS + ERRS)) failed)" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          PASSED=$((TOTAL_TESTS - FAILURES - ERRORS - SKIPPED))

          echo "| Metric | Count | Percentage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| üìù Total Tests | $TOTAL_TESTS | 100% |" >> $GITHUB_STEP_SUMMARY

          if [ $TOTAL_TESTS -gt 0 ]; then
            PASS_PCT=$((PASSED * 100 / TOTAL_TESTS))
            FAIL_PCT=$((FAILURES * 100 / TOTAL_TESTS))
            ERR_PCT=$((ERRORS * 100 / TOTAL_TESTS))
            SKIP_PCT=$((SKIPPED * 100 / TOTAL_TESTS))
          else
            PASS_PCT=0
            FAIL_PCT=0
            ERR_PCT=0
            SKIP_PCT=0
          fi

          echo "| ‚úÖ Passed | $PASSED | ${PASS_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | $FAILURES | ${FAIL_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| üî• Errors | $ERRORS | ${ERR_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚è≠Ô∏è Skipped | $SKIPPED | ${SKIP_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $FAILURES -eq 0 ] && [ $ERRORS -eq 0 ]; then
            echo "### ‚úÖ All unit tests passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üéâ Great job! All $TOTAL_TESTS unit tests are passing." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Unit Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Failed Tests:** $FAILURES" >> $GITHUB_STEP_SUMMARY
            echo "**Errors:** $ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List failed tests
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üîç View Failed Test Details</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            for file in target/surefire-reports/*.txt; do
              if [ -f "$file" ] && grep -q "FAILURE\|ERROR" "$file" 2>/dev/null; then
                echo "File: $(basename $file)" >> $GITHUB_STEP_SUMMARY
                grep -A 10 "FAILURE\|ERROR" "$file" 2>/dev/null | head -30 >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done

            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Full test results:** Available in artifacts (7-day retention)" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå No test results found" >> $GITHUB_STEP_SUMMARY
        fi
