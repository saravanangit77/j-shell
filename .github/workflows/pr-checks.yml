name: PR Checks

on:
  pull_request:
    branches:
      - main
      - master
      - develop
  push:
    branches:
      - main
      - master
      - develop

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build:
    name: Build & Compile
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: Compile code
      run: mvn clean compile
      
    - name: Package
      run: mvn package -DskipTests
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: jar-package
        path: target/*.jar
        retention-days: 1
  
  unit-tests:
    name: Unit Tests
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: Run unit tests
      run: mvn test
      
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: target/surefire-reports/
        retention-days: 7
        
    - name: Generate test report
      if: always() && github.event_name == 'push'
      uses: dorny/test-reporter@v1
      with:
        name: Unit Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: true
      continue-on-error: true
      
    - name: Publish test results summary
      if: always()
      run: |
        echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d target/surefire-reports ]; then
          # Count test files
          TEST_FILES=$(find target/surefire-reports -name "TEST-*.xml" -type f | wc -l | tr -d ' ')
          
          # Parse test results from XML files
          TOTAL_TESTS=0
          FAILURES=0
          ERRORS=0
          SKIPPED=0
          
          for file in target/surefire-reports/TEST-*.xml; do
            if [ -f "$file" ]; then
              TESTS=$(grep -oP 'tests="\K[0-9]+' "$file" | head -1)
              FAILS=$(grep -oP 'failures="\K[0-9]+' "$file" | head -1)
              ERRS=$(grep -oP 'errors="\K[0-9]+' "$file" | head -1)
              SKIP=$(grep -oP 'skipped="\K[0-9]+' "$file" | head -1)
              
              TOTAL_TESTS=$((TOTAL_TESTS + ${TESTS:-0}))
              FAILURES=$((FAILURES + ${FAILS:-0}))
              ERRORS=$((ERRORS + ${ERRS:-0}))
              SKIPPED=$((SKIPPED + ${SKIP:-0}))
            fi
          done
          
          echo "ðŸ“Š **Test Suite Summary**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | $((TOTAL_TESTS - FAILURES - ERRORS - SKIPPED)) |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | $FAILURES |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¥ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $FAILURES -eq 0 ] && [ $ERRORS -eq 0 ]; then
            echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some tests failed - check artifacts for details**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Test results uploaded as artifacts (7-day retention)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ No test results found" >> $GITHUB_STEP_SUMMARY
        fi
  
  integration-tests:
    name: Integration Tests
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: Run integration tests
      run: mvn clean test -Dtest="*IntegrationTest"
      
    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: target/surefire-reports/
        retention-days: 7
        
    - name: Generate integration test report
      if: always() && github.event_name == 'push'
      uses: dorny/test-reporter@v1
      with:
        name: Integration Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: true
      continue-on-error: true
      
    - name: Publish integration test summary
      if: always()
      run: |
        echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d target/surefire-reports ]; then
          # Parse test results from XML files
          TOTAL_TESTS=0
          FAILURES=0
          ERRORS=0
          SKIPPED=0
          
          for file in target/surefire-reports/TEST-*.xml; do
            if [ -f "$file" ]; then
              TESTS=$(grep -oP 'tests="\K[0-9]+' "$file" | head -1)
              FAILS=$(grep -oP 'failures="\K[0-9]+' "$file" | head -1)
              ERRS=$(grep -oP 'errors="\K[0-9]+' "$file" | head -1)
              SKIP=$(grep -oP 'skipped="\K[0-9]+' "$file" | head -1)
              
              TOTAL_TESTS=$((TOTAL_TESTS + ${TESTS:-0}))
              FAILURES=$((FAILURES + ${FAILS:-0}))
              ERRORS=$((ERRORS + ${ERRS:-0}))
              SKIPPED=$((SKIPPED + ${SKIP:-0}))
            fi
          done
          
          echo "ðŸ“Š **Integration Test Summary**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | $((TOTAL_TESTS - FAILURES - ERRORS - SKIPPED)) |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | $FAILURES |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¥ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $FAILURES -eq 0 ] && [ $ERRORS -eq 0 ]; then
            echo "âœ… **All integration tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some tests failed - check artifacts for details**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Test results uploaded as artifacts (7-day retention)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ No test results found" >> $GITHUB_STEP_SUMMARY
        fi
  
  code-quality:
    name: Code Quality Checks
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: Check for compilation warnings
      run: mvn compile -Xlint:deprecation -Xlint:unchecked
      continue-on-error: true
      
    - name: Verify project structure
      run: mvn verify -DskipTests

